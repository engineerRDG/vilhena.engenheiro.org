<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Medição - Vilhena Serviços</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* 1. IDENTIDADE VISUAL E CSS PADRÃO */
        :root {
            --bg-page: #f0f0f0;
            --bg-container: #ffffff;
            --header-bg: #333333;
            --header-text: #ffffff;
            --border-color: #cccccc;
            --text-primary: #333333;
            --btn-primary: #28a745;
            --btn-primary-hover: #218838;
            --btn-report: #007bff;
            --btn-report-hover: #0056b3;
            --btn-danger: #dc3545;
            --btn-danger-hover: #c82333;
            --btn-secondary: #ffc107;
            --btn-secondary-hover: #e0a800;
            --matriz-header-bg: #1f4e78;
            --matriz-header-text: #fff;
            --matriz-row-even: #f2f6fa;
            --matriz-row-hover: #dbeecf;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-page);
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-primary);
            margin: 0;
            padding: 30px 20px;
            font-size: 14px;
        }

        /* 2. ESTRUTURA E VISUAL3D */
        .container {
            background-color: var(--bg-container);
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15), 0 10px 20px rgba(0,0,0,0.1);
            padding: 25px;
            border: 1px solid #d0d0d0;
            position: relative;
            z-index: 1;
        }

        /* Cabeçalho */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--header-bg);
            padding-bottom: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { height: 50px; width: auto; }
        .header-title h1 { margin: 0; font-size: 26px; color: var(--header-bg); text-transform: uppercase; line-height: 1.2; }
        .header-title div { font-size: 13px; color: #666; letter-spacing: 1px; }
        .header-menu { display: flex; gap: 10px; }

        .section-title {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 8px 12px;
            font-size: 16px;
            font-weight: bold;
            margin: 20px 0 15px 0;
            display: inline-block;
            text-transform: uppercase;
        }

        /* Grid System */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        /* KPI Cards */
        .grid-kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .kpi-card {
            border: 1px solid var(--border-color);
            padding: 15px;
            background: #fff;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .kpi-card .label {
            font-size: 12px;
            text-transform: uppercase;
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #666;
        }
        .kpi-card .value { font-size: 28px; font-weight: bold; color: #000; }

        /* Inputs e Controles */
        input, select {
            font-family: 'Courier New', Courier, monospace;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fff;
            color: #333;
        }
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f8f8;
            padding: 15px;
            border: 1px solid #eee;
            border-left: 4px solid var(--header-bg);
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
            flex-grow: 1;
        }
        .control-group label {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
            color: #444;
        }

        /* Botões */
        button {
            font-family: 'Courier New', Courier, monospace;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
            border-radius: 4px;
            transition: background 0.2s, transform 0.1s;
        }
        button:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--btn-primary); color: white; }
        .btn-primary:hover { background-color: var(--btn-primary-hover); }
        .btn-report { background-color: var(--btn-report); color: white; }
        .btn-report:hover { background-color: var(--btn-report-hover); }
        .btn-secondary { background-color: var(--btn-secondary); color: #333; border: 1px solid #d39e00; }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover); }
        
        .btn-radio-group {
            display: flex; border: 1px solid #ccc; border-radius: 4px; overflow: hidden;
        }
        .btn-radio-group label {
            padding: 8px 15px; cursor: pointer; background: #eee; border-right: 1px solid #ccc;
            font-size: 12px; font-weight: bold; text-transform: uppercase;
        }
        .btn-radio-group input { display: none; }
        .btn-radio-group input:checked + label { background: #333; color: white; }

        /* Tabelas Gerais */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); }
        #data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        #data-table thead { background-color: var(--header-bg); color: white; }
        #data-table th, #data-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border-color); border-right: 1px solid #eee; }
        #data-table th:last-child, #data-table td:last-child { border-right: none; }
        #data-table th.sortable { cursor: pointer; user-select: none; }
        #data-table th.sortable:hover { background-color: #444; }
        #data-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        #data-table tbody tr:hover { background-color: #e9ecef; cursor: pointer; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* --- ESTILO DA MATRIZ --- */
        .matriz-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 15px; padding-bottom: 10px; }
        .matriz-header h2 { font-size: 14pt; margin: 0; text-transform: uppercase; }
        .matriz-header h3 { font-size: 12pt; margin: 5px 0 0 0; font-weight: normal; }

        .matriz-table { width: 100%; border-collapse: collapse; font-size: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .matriz-table th { background-color: var(--matriz-header-bg) !important; color: var(--matriz-header-text) !important; font-weight: bold; text-transform: uppercase; padding: 8px 5px; border: 1px solid #ddd; vertical-align: middle; }
        .matriz-table td { border: 1px solid #ddd; padding: 6px 5px; vertical-align: middle; color: #333; }
        .matriz-table tbody tr:nth-child(even) { background-color: var(--matriz-row-even); }
        .matriz-table tbody tr:hover { background-color: var(--matriz-row-hover); transition: background 0.2s; }

        .col-ref { width: 10%; }
        .col-emb { width: 14%; }
        .col-serv { width: 14%; }
        .col-item { width: 8%; text-align: center; font-family: monospace; font-weight: bold; }
        .col-desc { width: 22%; }
        .col-uni { width: 5%; text-align: center; }
        .col-qtd { width: 8%; text-align: center; }
        .col-vunit { width: 9%; text-align: right; }
        .col-total { width: 10%; text-align: right; font-weight: bold; color: #000; }

        /* Rodapé do relatório */
        .report-footer { margin-top: 40px; display: flex; justify-content: space-between; page-break-inside: avoid; }
        
        /* Gráficos */
        .chart-wrapper { position: relative; height: 300px; width: 100%; border: 1px solid #ddd; padding: 10px; background: #fff; }
        .chart-label { text-align: center; font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #333; text-transform: uppercase; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }

        /* Lista Embarcação */
        #vesselPerformanceContainer { height: 300px; overflow-y: auto; border: 1px solid #333; background: #fff; }
        .vessel-list-header { display: flex; background-color: var(--header-bg); color: white; padding: 8px 10px; font-weight: bold; font-size: 12px; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
        .vessel-col-name { flex: 2; } 
        .vessel-col-city { flex: 1; }
        .vessel-col-val { flex: 1; text-align: right; }
        .vessel-list-item { display: flex; align-items: center; padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 12px; }
        .vessel-list-item:hover { background-color: #f0f0f0; }
        .vessel-name-text { font-weight: bold; color: #000; }
        .vessel-city-text { color: #555; }
        .vessel-value-text { font-family: 'Courier New', monospace; font-weight: bold; color: #0056b3; }

        /* Footer */
        footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--header-bg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .footer-logo { height: 40px; width: auto; }
        .footer-info { text-align: right; font-size: 12px; color: #555; line-height: 1.4; }

        /* Modais */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; border: 2px solid var(--header-bg); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .modal-header { background: var(--header-bg); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .modal-header h3 { margin: 0; font-size: 16px; text-transform: uppercase; }
        .modal-close { background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; font-weight: bold; }
        .modal-body { padding: 20px; }

        /* Impressão */
        .print-area { display: none; }
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background-color: white; margin: 0; padding: 0; font-family: 'Courier New', monospace; font-size: 10pt; }
            .container, .no-print, .modal-overlay { display: none !important; }
            .print-area { display: block; width: 100%; max-width: 100%; margin: 0 auto; }
            .matriz-table th { background-color: #eee !important; color: #000 !important; -webkit-print-color-adjust: exact; }
            .matriz-table tbody tr:nth-child(even) { background-color: transparent !important; }
            .matriz-table tbody tr:hover { background-color: transparent !important; }
            .matriz-table th, .matriz-table td { border: 1px solid #000; }
            .text-right-p { text-align: right; }
            .text-center-p { text-align: center; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-left">
                <img src="https://raw.githubusercontent.com/engineerRDG/vilhena.engenheiro.org/refs/heads/main/imagem/logo.png" alt="Vilhena Serviços Logo" class="header-logo">
                <div class="header-title">
                    <h1>Vilhena Serviços Ltda.</h1>
                    <div>CONTROLE DE MEDIÇÃO TÉCNICA</div>
                </div>
            </div>
            <div class="header-menu">
                <button class="btn-secondary" onclick="window.location.href='rs.html'">RS</button>
                <button class="btn-primary" onclick="window.location.href='medicao.html'">MEDIÇÃO</button>
            </div>
        </header>

        <div class="grid-kpi">
            <div class="kpi-card">
                <span class="label">Itens Medidos</span>
                <div id="kpi-total-items" class="value">0</div>
            </div>
            <div class="kpi-card">
                <span class="label">Valor Medido</span>
                <div id="kpi-total-value" class="value">R$ 0,00</div>
            </div>
            <div class="kpi-card">
                <span class="label">Ref.</span>
                <div id="kpi-month" class="value">-</div>
            </div>
            <div class="kpi-card">
                <span class="label">Município</span>
                <div id="kpi-city" class="value">-</div>
            </div>
        </div>

        <div class="grid-layout">
            <div>
                <div class="chart-label">MEDIÇÃO POR EMBARCAÇÃO</div>
                <div id="vesselPerformanceContainer">
                    <div class="text-center p-3 text-muted">Aguardando dados...</div>
                </div>
            </div>
            
            <div>
                <div class="chart-label">ANÁLISE DE PARETO (TOP 8)</div>
                <div class="chart-wrapper">
                    <canvas id="paretoChart"></canvas>
                </div>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">

        <div class="controls-bar">
            <div class="control-group" style="display: flex; gap: 10px; align-items: flex-end;">
                <!-- BOTÃO RELATÓRIO MENSAL REMOVIDO CONFORME SOLICITAÇÃO -->
                <button id="btn-generate-boletim" class="btn-secondary" style="background-color: #333; color: white;">BOLETIM</button>
                <button id="btn-matriz" class="btn-primary" style="background-color: var(--btn-primary);">MATRIZ DE LANÇAMENTO</button>
            </div>
            <div class="control-group">
                <label>Reservatório</label>
                <select id="reservatorio-filter"></select>
            </div>
            <div class="control-group">
                <label>Referência</label>
                <select id="month-filter"></select>
            </div>
            <div class="control-group">
                <label>Município</label>
                <select id="municipio-filter"></select>
            </div>
            <div class="control-group">
                <label>Embarcação</label>
                <select id="vessel-filter"></select>
            </div>
            <div class="control-group" style="margin-left: auto;">
                <div class="btn-radio-group">
                    <input type="radio" id="view-unitario" name="view-mode" value="unitario" checked>
                    <label for="view-unitario">Unitário</label>
                    <input type="radio" id="view-geral" name="view-mode" value="geral">
                    <label for="view-geral">Geral</label>
                </div>
            </div>
        </div>

        <!-- TÍTULO "LISTA DE MEDIÇÕES" REMOVIDO CONFORME SOLICITAÇÃO -->
        
        <div class="table-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descritivo</th>
                        <th class="sortable" id="sort-qty">Qtd. <span id="icon-qty">▼</span></th>
                        <th class="sortable text-right" id="sort-val">Valor Total <span id="icon-val">▼</span></th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <tr><td colspan="4" class="text-center">[ CARREGANDO... ]</td></tr>
                </tbody>
            </table>
        </div>

        <footer>
            <div class="footer-left">
                <img src="https://raw.githubusercontent.com/engineerRDG/vilhena.engenheiro.org/refs/heads/main/imagem/eletrobras.png" alt="Logo Eletrobras" class="footer-logo">
            </div>
            <div class="footer-info">
                <p><b>Vilhena Serviços LTDA</b><br>Departamento de Engenharia e Manutenção</p>
                <p><b>Rodrigo M. Araujo</b><br>Engenheiro Mecânico<br>Engenheiro de Segurança do Trabalho</p>
            </div>
        </footer>
    </div>

    <div id="modal-details" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detail-title">Detalhes</h3>
                <button class="modal-close" onclick="closeModal('modal-details')">X</button>
            </div>
            <div class="modal-body">
                <div id="detail-content"></div>
                <hr>
                <p><strong>Quantidade Total:</strong> <span id="detail-qty"></span></p>
                <p><strong>Valor Total:</strong> <span id="detail-val"></span></p>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn-secondary" onclick="closeModal('modal-details')">FECHAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-report" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 id="modal-report-title">Relatório</h3>
                <button class="modal-close" onclick="closeModal('modal-report')">X</button>
            </div>
            <div class="modal-body" id="report-screen-content" style="background: #f0f0f0; padding: 10px;">
                <div style="background: white; padding: 20px; border: 1px solid #ccc;">
                    <p>Selecione os filtros e clique em um dos botões de relatório.</p>
                </div>
            </div>
            <div class="modal-header no-print" style="border-top: 1px solid #ccc; border-bottom: none; background: white;">
                <div></div>
                <button class="btn-report" onclick="window.print()">IMPRIMIR</button>
            </div>
        </div>
    </div>

    <div id="modal-matriz" class="modal-overlay">
        <div class="modal-content" style="max-width: 95%;">
            <div class="modal-header no-print">
                <h3>Matriz de Lançamento</h3>
                <button class="modal-close" onclick="closeModal('modal-matriz')">X</button>
            </div>
            <div class="modal-body" id="matriz-screen-content" style="padding: 0;"></div>
            <div class="modal-header no-print" style="border-top: 1px solid #ccc; border-bottom: none; background: white; padding-top: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button id="btn-download-xls" class="btn-secondary" style="background-color: #1f7a38; color: white;">XLS (FORMATADO)</button>
                </div>
                <div style="margin-left: auto;">
                    <button class="btn-primary" onclick="window.print()">IMPRIMIR MATRIZ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="print-area" id="print-content">
    </div>

    <script>
    window.openModal = function(id) { document.getElementById(id).classList.add('active'); }
    window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); }
    
    // Função para copiar texto ao clicar
    window.copyText = function(el, val) {
        const text = val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        navigator.clipboard.writeText(text).then(() => {
            const originalBg = el.style.backgroundColor;
            el.style.backgroundColor = '#aaffaa';
            setTimeout(() => el.style.backgroundColor = originalBg || 'transparent', 300);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        
        // --- MAPEAMENTO DE VALORES FIXOS POR MUNICÍPIO ---
        // para todos os municípios ('default').
        // EDITE OS VALORES ABAIXO conforme a tabela da imagem para cada município específico.
        const VALORES_FIXOS_MUNICIPIO = {
            'Delfinópolis': 119142.70, // Alterar se necessário
            'Alfenas': 39714.23,      // Alterar se necessário
            'Guapé': 59571.35,        // Alterar se necessário
            'Carmo do Rio Claro': 39714.23, // Alterar se necessário
            'Campo Belo': 19857.12,      // Alterar se necessário
            'Campo do Meio': 19857.12,        // Alterar se necessário
            'Cristais': 19857.12,        // Alterar se necessário
            'Fama': 19857.12,      // Alterar se necessário
            'Três Pontas': 19857.12,        // Alterar se necessário
            // Adicione outros municípios aqui com seus respectivos valores fixos
        };

        const SERVICES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-EzfpINGaWJduqHgUQwgjK2hzakenB8-zIFSO7eqPtAoZzSin9DV0eyxg9_wEPaWE79lYxiGMQ_9b/pub?gid=1132804567&single=true&output=csv';
        const PRICES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8an6Vae5OUkZVObcjTNcqUaXZKD-AtlJCg1WRK-6Aw2DDOoLZHGTB59oDSBK1iGc3BEGWI4u_6Qh3/pub?gid=439074154&single=true&output=csv';
        const LOCATIONS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5QP1Y7FXm3gRkgb3Xl9iATvUE25q5wq22-X3k7QZG6TusZ3uURbaVPS1os3Gl4G0FxyK25TOtGCj0/pub?gid=0&single=true&output=csv';
        
        const VESSEL_MAPPING = {
            "Fama": "Alfenas", "Delfinópolis": "Alfenas", "Saliba": "Campo Belo", "São Francisco III": "Campo do Meio",
            "Águas Verdes": "Carmo do Rio Claro", "Itapiché": "Carmo do Rio Claro", "Fernandes": "Cristais",
            "Delfinópolis I": "Delfinópolis", "Canastra": "Delfinópolis", "Nossa Senhora dos Navegantes": "Delfinópolis",
            "Nossa Senhora dos Navegantes VII": "Delfinópolis", "Nossa Senhora dos Navegantes X": "Delfinópolis",
            "Rio Grande IV": "Delfinópolis", "São João Batista do Glória": "Delfinópolis", "Araúna": "Fama",
            "Guapé": "Guapé", "Harmonia": "Guapé", "São Francisco I": "Guapé", "Pontalete": "Três Pontas"
        };

        let allProcessedData = [];
        let chartInstances = {};
        let currentSort = { column: 'valorCalculado', direction: 'desc' };

        const formatCurrency = (value) => !isNaN(value) ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
        const monthMap = { 'janeiro': 0, 'fevereiro': 1, 'março': 2, 'abril': 3, 'maio': 4, 'junho': 5, 'julho': 6, 'agosto': 7, 'setembro': 8, 'outubro': 9, 'novembro': 10, 'dezembro': 11 };
        
        const parseDate = dateStr => {
            if (!dateStr || typeof dateStr !== 'string' || dateStr.trim() === '') return null;
            const parts = dateStr.trim().split('/');
            if (parts.length === 2) {
                const [monthName, year] = parts.map(p => p.trim().toLowerCase());
                const monthIndex = monthMap[monthName];
                if (monthIndex !== undefined && year?.length === 4) return new Date(year, monthIndex, 1);
            }
            if (parts.length === 3) {
                const [day, monthName, year] = parts.map(p => p.trim().toLowerCase());
                const monthIndex = monthMap[monthName];
                if (monthIndex !== undefined && year?.length === 4 && !isNaN(day)) return new Date(year, monthIndex, parseInt(day));
            }
            const parsedTime = Date.parse(dateStr);
            if (!isNaN(parsedTime)) return new Date(parsedTime);
            
            return null;
        };

        const parseQuantity = qtyStr => {
            if (typeof qtyStr !== 'string' || qtyStr.trim() === '') return 0;
            return parseFloat(qtyStr.trim().replace(',', '.')) || 0;
        };

        function destroyChart(chartId) { if (chartInstances[chartId]) chartInstances[chartId].destroy(); }

        function updateKPIs(data, selectedMonthValue, selectedMunicipioValue) {
            document.getElementById('kpi-total-items').textContent = data.length.toLocaleString('pt-BR');
            const totalVal = data.reduce((sum, item) => sum + item.valorCalculado, 0);
            document.getElementById('kpi-total-value').textContent = formatCurrency(totalVal);
            const monthSel = document.getElementById('month-filter');
            document.getElementById('kpi-month').textContent = selectedMonthValue === 'all' ? 'TODOS' : monthSel.options[monthSel.selectedIndex].text;
            document.getElementById('kpi-city').textContent = (selectedMunicipioValue === 'all' || !selectedMunicipioValue) ? 'TODOS' : selectedMunicipioValue;
        }

        function populateReservatorioFilter() { 
            const sel = document.getElementById('reservatorio-filter');
            sel.innerHTML = `<option value="all">TODOS</option><option value="furnas">FURNAS</option><option value="mascarenhas">MASCARENHAS</option>`;
        }
        function populateMonthFilter(data) {
            const sel = document.getElementById('month-filter');
            const months = new Set(data.map(item => item.dataConclusao ? `${item.dataConclusao.getFullYear()}-${(item.dataConclusao.getMonth() + 1).toString().padStart(2, '0')}` : null).filter(m => m !== null));
            const sortedMonths = Array.from(months).sort().reverse();
            sel.innerHTML = '<option value="all">TODAS REFERÊNCIAS</option>';
            sortedMonths.forEach(monthKey => {
               const [year, monthNum] = monthKey.split('-');
               const monthName = new Date(year, monthNum - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
               const opt = document.createElement('option');
               opt.value = monthKey; opt.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
               sel.appendChild(opt);
            });
        }
        function populateMunicipioFilter(data) {
            const sel = document.getElementById('municipio-filter');
            const municipios = new Set(data.map(item => item.municipio || 'Não especificada'));
            sel.innerHTML = '<option value="all">TODOS OS MUNICÍPIOS</option>';
            Array.from(municipios).sort().forEach(m => sel.appendChild(new Option(m, m)));
        }
        function populateVesselFilter(data) {
            const sel = document.getElementById('vessel-filter');
            const vessels = new Set(data.map(item => item.embarcação || 'Não especificada'));
            sel.innerHTML = '<option value="all">TODAS AS EMBARCAÇÕES</option>';
            Array.from(vessels).sort().forEach(v => sel.appendChild(new Option(v, v)));
        }

        function aggregateData(data) {
            const aggregated = new Map();
            data.forEach(item => {
                const key = `${item.codigo}|${item.descritivo}`;
                if (!aggregated.has(key)) {
                    aggregated.set(key, { 
                        codigo: item.codigo, descritivo: item.descritivo, unidade: item.unidade, 
                        quantidadeNumerica: 0, valorCalculado: 0, details: {} 
                    });
                }
                const entry = aggregated.get(key);
                entry.quantidadeNumerica += item.quantidadeNumerica;
                entry.valorCalculado += item.valorCalculado;
                const vessel = item.embarcação || 'Não especificada';
                if (!entry.details[vessel]) entry.details[vessel] = { qty: 0, val: 0 };
                entry.details[vessel].qty += item.quantidadeNumerica;
                entry.details[vessel].val += item.valorCalculado;
            });
            return Array.from(aggregated.values());
        }

        function renderTable(data) {
            const viewMode = document.querySelector('input[name="view-mode"]:checked').value;
            const tableData = viewMode === 'geral' ? aggregateData(data) : data;
            const sortedData = [...tableData].sort((a, b) => {
                const valA = a[currentSort.column], valB = b[currentSort.column];
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            document.getElementById('icon-qty').textContent = currentSort.column === 'quantidadeNumerica' ? (currentSort.direction === 'asc' ? '▲' : '▼') : '▼';
            document.getElementById('icon-val').textContent = currentSort.column === 'valorCalculado' ? (currentSort.direction === 'asc' ? '▲' : '▼') : '▼';
            const tbody = document.getElementById('data-table-body');
            if (sortedData.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum item encontrado.</td></tr>'; return; }
            let html = '';
            sortedData.forEach(item => {
                const detailsStr = item.details ? `'${JSON.stringify(item.details)}'` : '';
                const onClick = `openDetail(${detailsStr}, '${item.descritivo}', '${item.embarcação || 'N/A'}', ${item.quantidadeNumerica}, ${item.valorCalculado}, '${item.unidade || ''}')`;
                html += `<tr onclick="${onClick}">
                    <td style="font-family: monospace; font-weight: bold;">${item.codigo || ''}</td>
                    <td>${item.descritivo || ''}</td>
                    <td class="text-center">${(item.quantidadeNumerica || 0).toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                    <td class="text-right">${formatCurrency(item.valorCalculado)}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        window.openDetail = function(detailsStr, desc, emb, qty, val, unit) {
            document.getElementById('detail-title').textContent = desc || 'Detalhes do Item';
            document.getElementById('detail-qty').textContent = `${qty.toLocaleString('pt-BR')} ${unit}`;
            document.getElementById('detail-val').textContent = formatCurrency(val);
            const contentDiv = document.getElementById('detail-content');
            if (detailsStr) {
                let detailsHTML = '<ul style="list-style: none; padding: 0;">';
                const details = typeof detailsStr === 'string' ? JSON.parse(detailsStr) : detailsStr;
                Object.entries(details).forEach(([v, d]) => {
                    detailsHTML += `<li style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:5px 0;">
                        <span>${v}</span>
                        <span>${d.qty.toLocaleString('pt-BR')} ${unit} (${formatCurrency(d.val)})</span>
                    </li>`;
                });
                contentDiv.innerHTML = detailsHTML + '</ul>';
            } else {
                contentDiv.innerHTML = `<p><strong>Embarcação:</strong> <span style="font-weight:bold; color:#0056b3;">${emb}</span></p>`;
            }
            openModal('modal-details');
        };

        function getContractItemCounts(data) {
            const itemData = data.reduce((acc, item) => {
                const key = item['codigo'] || 'Não especificado';
                if (!acc[key]) acc[key] = { count: 0, description: item['descritivo'] || 'Sem descrição' };
                acc[key].count += item.quantidadeNumerica; 
                return acc;
            }, {});
            return Object.entries(itemData).map(([name, { count, description }]) => ({ name, count, description })).sort((a, b) => b.count - a.count);
        }

        function renderVesselPerformanceList(data) {
            const container = document.getElementById('vesselPerformanceContainer');
            if (data.length === 0) { container.innerHTML = '<div class="text-center p-3 text-muted">Sem dados para exibir.</div>'; return; }
            const vesselData = data.reduce((acc, item) => {
                const v = item.embarcação || 'Não especificada';
                if (!acc[v]) acc[v] = { valor: 0, municipio: item.municipio || 'Não especificada' };
                acc[v].valor += item.valorCalculado;
                return acc;
            }, {});
            const sorted = Object.entries(vesselData).sort((a,b) => b[1].valor - a[1].valor);
            let html = `
                <div class="vessel-list-header">
                    <div class="vessel-col-name">EMBARCAÇÃO</div>
                    <div class="vessel-col-city">MUNICÍPIO</div>
                    <div class="vessel-col-val">TOTAL</div>
                </div>
            `;
            sorted.forEach(([name, info]) => {
                html += `
                    <div class="vessel-list-item">
                        <div class="vessel-col-name"><span class="vessel-name-text">${name}</span></div>
                        <div class="vessel-col-city"><span class="vessel-city-text">${info.municipio}</span></div>
                        <div class="vessel-col-val"><span class="vessel-value-text">${formatCurrency(info.valor)}</span></div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderParetoChart(data) {
            destroyChart('paretoChart');
            if (data.length === 0) return;
            const ctx = document.getElementById('paretoChart').getContext('2d');
            const top8 = getContractItemCounts(data).slice(0, 8);
            const total = top8.reduce((s, i) => s + i.count, 0);
            let cum = 0;
            const paretoData = top8.map(i => ({ ...i, cumPct: (cum += i.count) / total * 100 }));
            
            chartInstances['paretoChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: paretoData.map(d => d.name),
                    datasets: [
                        { label: 'Quant', data: paretoData.map(d => d.count), backgroundColor: '#ffc107', borderColor: '#333', borderWidth: 1, yAxisID: 'y' },
                        { label: '%', data: paretoData.map(d => d.cumPct.toFixed(1)), type: 'line', borderColor: '#dc3545', yAxisID: 'y1', tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    return paretoData[context.dataIndex].description;
                                }
                            }
                        }
                    },
                    scales: { y: { position: 'left' }, y1: { type: 'linear', position: 'right', min: 0, max: 100, grid: { drawOnChartArea: false } } }
                }
            });
        }

        function applyFilters() {
            const rVal = document.getElementById('reservatorio-filter').value;
            const mVal = document.getElementById('month-filter').value;
            const munVal = document.getElementById('municipio-filter').value;
            const vVal = document.getElementById('vessel-filter').value;

            const filtered = allProcessedData.filter(item => {
                if (!item.dataConclusao) return false;
                const rMatch = rVal === 'all' || (rVal === 'furnas' && item.municipio !== 'Delfinópolis') || (rVal === 'mascarenhas' && item.municipio === 'Delfinópolis');
                const mMatch = mVal === 'all' || `${item.dataConclusao.getFullYear()}-${(item.dataConclusao.getMonth() + 1).toString().padStart(2, '0')}` === mVal;
                const munMatch = munVal === 'all' || item.municipio === munVal; 
                const vMatch = vVal === 'all' || item.embarcação === vVal;
                return rMatch && mMatch && munMatch && vMatch;
            });

            updateKPIs(filtered, mVal, munVal);
            renderTable(filtered);
            renderParetoChart(filtered);
            renderVesselPerformanceList(filtered);
        }

        // --- BOLETIM DE MEDIÇÃO PADRÃO (ATUALIZADO COM VALORES FIXOS POR MUNICÍPIO) ---
        function generateBoletim() {
            document.getElementById('modal-report-title').textContent = "BOLETIM DE MEDIÇÃO PADRÃO";

            const mVal = document.getElementById('month-filter').value;
            const munVal = document.getElementById('municipio-filter').value;

            if (mVal === 'all') { alert("Selecione uma Referência/Mês para o Boletim."); return; }
            if (munVal === 'all') { alert("Selecione um Município para o Boletim."); return; }

            openModal('modal-report');
            const reportScreen = document.getElementById('report-screen-content');
            reportScreen.innerHTML = '<div class="text-center p-4">[ PROCESSANDO BOLETIM... ]</div>';

            const [year, monthNum] = mVal.split('-');
            const dateObj = new Date(year, monthNum - 1, 1);
            const monthName = dateObj.toLocaleString('pt-BR', { month: 'long' });
            const monthNameCap = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            const lastDay = new Date(year, monthNum, 0).getDate();
            
            const periodo = `01 de ${monthNameCap} de ${year} a ${lastDay} de ${monthNameCap} de ${year}`;

            const data = allProcessedData.filter(item => {
                return item.municipio === munVal && `${item.dataConclusao.getFullYear()}-${(item.dataConclusao.getMonth() + 1).toString().padStart(2,'0')}` === mVal;
            });

            const vesselTotals = {};
            let totalServicos = 0;
            data.forEach(item => {
                if(!vesselTotals[item.embarcação]) vesselTotals[item.embarcação] = 0;
                vesselTotals[item.embarcação] += item.valorCalculado;
                totalServicos += item.valorCalculado;
            });

            // BUSCA VALOR FIXO ESPECÍFICO DO MUNICÍPIO OU USA O PADRÃO
            const valorFixoMunicipio = VALORES_FIXOS_MUNICIPIO[munVal] || VALORES_FIXOS_MUNICIPIO['default'];

            const totalGeral = totalServicos + valorFixoMunicipio;

            let html = `
                <div style="background: white; padding: 20px; border: 1px solid #ccc; font-family: Arial, sans-serif; font-size: 12pt;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="margin: 0; font-size: 18pt; text-transform: uppercase;">Boletim de Medição</h2>
                        <h3 style="margin: 5px 0 20px 0; font-size: 14pt;">Prefeitura Municipal de ${munVal.toUpperCase()}</h3>
                        <p style="margin: 0; font-weight: bold;">Período de Referência: ${periodo}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; border: 1px solid black; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #eee; font-weight: bold; text-transform: uppercase;">
                                <th style="border: 1px solid black; padding: 10px; text-align: left; width: 75%;">Embarcação</th>
                                <th style="border: 1px solid black; padding: 10px; text-align: right; width: 25%;">VALOR MEDIDO</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(vesselTotals).forEach(([vessel, val]) => {
                html += `
                    <tr>
                        <td style="border: 1px solid black; padding: 8px;">
                            <strong>${vessel}</strong>
                        </td>
                        <td style="border: 1px solid black; padding: 8px; text-align: right; cursor: pointer;" onclick="copyText(this, ${val})" title="Clique para copiar">
                            ${formatCurrency(val)}
                        </td>
                    </tr>
                `;
            });

            html += `
                    <tr>
                        <td style="border: 1px solid black; padding: 8px;">
                            Equipe Técnica e Administração Local
                        </td>
                        <td style="border: 1px solid black; padding: 8px; text-align: right; cursor: pointer;" onclick="copyText(this, ${valorFixoMunicipio})" title="Clique para copiar">
                            ${formatCurrency(valorFixoMunicipio)}
                        </td>
                    </tr>
            `;

            html += `
                    <tr style="background-color: #ddd; font-weight: bold; font-size: 1.1em;">
                        <td style="border: 1px solid black; padding: 12px; text-align: right;">Total do Faturamento :</td>
                        <td style="border: 1px solid black; padding: 12px; text-align: right; cursor: pointer;" onclick="copyText(this, ${totalGeral})" title="Clique para copiar">
                            ${formatCurrency(totalGeral)}
                        </td>
                    </tr>
                        </tbody>
                    </table>
                </div>
            `;

            reportScreen.innerHTML = html;
            document.getElementById('print-content').innerHTML = html;
        }

        // --- EXPORTAÇÃO XLS ---
        function exportMatrixToXLS() {
            const mVal = document.getElementById('month-filter').value;
            const munVal = document.getElementById('municipio-filter').value;

            if (mVal === 'all' || munVal === 'all') {
                alert("Para exportar para Excel, selecione uma Referência e um Município específico.");
                return;
            }
            const dataForMatrix = allProcessedData.filter(item => {
                if (!item.dataConclusao) return false;
                const mMatch = `${item.dataConclusao.getFullYear()}-${(item.dataConclusao.getMonth() + 1).toString().padStart(2, '0')}` === mVal;
                const munMatch = item.municipio === munVal;
                return mMatch && munMatch;
            });
            if (dataForMatrix.length === 0) { alert("Não há dados para a combinação selecionada."); return; }
            
            dataForMatrix.sort((a, b) => {
                const embA = a.embarcação, embB = b.embarcação;
                if (embA < embB) return -1; if (embA > embB) return 1;
                return 0;
            });

            let tableRows = "";
            dataForMatrix.forEach(item => {
                const unitPrice = item.quantidadeNumerica > 0 ? (item.valorCalculado / item.quantidadeNumerica) : 0;
                tableRows += `
                    <tr>
                        <td>${item.referenciaStr || ''}</td>
                        <td>${item.embarcação || ''}</td>
                        <td>${item.servico || item.descritivo || ''}</td>
                        <td style="text-align: center;">${item.codigo || ''}</td>
                        <td>${item.descritivo || ''}</td>
                        <td style="text-align: center;">${item.unidade || ''}</td>
                        <td style="text-align: center;">${item.quantidadeNumerica.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: right;">${unitPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td style="text-align: right;">${item.valorCalculado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });

            const excelTemplate = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Calibri, sans-serif; font-size: 11pt; }
                        table { border-collapse: collapse; width: 100%; }
                        th { 
                            background-color: #1f7a38; 
                            color: #ffffff; 
                            font-weight: bold; 
                            text-align: center; 
                            border: 1px solid #000000;
                            padding: 10px;
                            text-transform: uppercase;
                        }
                        td { 
                            border: 1px solid #000000; 
                            padding: 5px; 
                            vertical-align: middle;
                        }
                    </style>
                </head>
                <body>
                    <table>
                        <thead>
                            <tr>
                                <th>REFERÊNCIA</th>
                                <th>EMBARCAÇÃO</th>
                                <th>SERVIÇO</th>
                                <th>CÓDIGO</th>
                                <th>DESCRITIVO</th>
                                <th>UNID.</th>
                                <th>QTD</th>
                                <th>VL. UNIT</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([excelTemplate], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Medicao_Formatada_${mVal}_${munVal}.xls`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- MATRIZ DE LANÇAMENTO (TELA) ---
        document.getElementById('btn-matriz').addEventListener('click', function() {
            const mVal = document.getElementById('month-filter').value;
            const munVal = document.getElementById('municipio-filter').value;
            if (mVal === 'all' || munVal === 'all') { alert("Para gerar a Matriz de Lançamento, selecione uma Referência e um Município específico."); return; }
            
            const dataForMatrix = allProcessedData.filter(item => {
                if (!item.dataConclusao) return false;
                const mMatch = `${item.dataConclusao.getFullYear()}-${(item.dataConclusao.getMonth() + 1).toString().padStart(2, '0')}` === mVal;
                const munMatch = item.municipio === munVal;
                return mMatch && munMatch;
            });

            if (dataForMatrix.length === 0) { alert("Não há dados para a combinação selecionada."); return; }
            
            dataForMatrix.sort((a, b) => {
                const embA = a.embarcação, embB = b.embarcação;
                if (embA < embB) return -1; if (embA > embB) return 1;
                return 0;
            });

            const monthSel = document.getElementById('month-filter');
            const munSel = document.getElementById('municipio-filter');
            const monthName = monthSel.options[monthSel.selectedIndex].text;
            const municipioName = munSel.options[munSel.selectedIndex].text;

            let rowsHtml = '';
            dataForMatrix.forEach(item => {
                const unitPrice = item.quantidadeNumerica > 0 ? (item.valorCalculado / item.quantidadeNumerica) : 0;
                rowsHtml += `
                    <tr>
                        <td class="col-ref">${item.referenciaStr || ''}</td>
                        <td class="col-emb">${item.embarcação || ''}</td>
                        <td class="col-serv">${item.servico || item.descritivo || ''}</td>
                        <td class="col-item">${item.codigo || ''}</td>
                        <td class="col-desc">${item.descritivo || ''}</td>
                        <td class="col-uni text-center-p">${item.unidade || ''}</td>
                        <td class="col-qtd text-center-p">${item.quantidadeNumerica.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                        <td class="col-vunit text-right-p">${formatCurrency(unitPrice)}</td>
                        <td class="col-total text-right-p">${formatCurrency(item.valorCalculado)}</td>
                    </tr>
                `;
            });
            const totalGeral = dataForMatrix.reduce((acc, i) => acc + i.valorCalculado, 0);

            const html = `
                <div class="print-area-wrapper">
                    <div class="matriz-header">
                        <h1>VILHENA SERVIÇOS LTDA.</h1>
                        <h2>MATRIZ DE LANÇAMENTO</h2>
                        <h3>${monthName} - ${municipioName}</h3>
                    </div>
                    <table class="matriz-table">
                        <thead>
                            <tr>
                                <th class="col-ref">REFERÊNCIA</th>
                                <th class="col-emb">EMBARCAÇÃO</th>
                                <th class="col-serv">SERVIÇO</th>
                                <th class="col-item">CÓDIGO</th>
                                <th class="col-desc">DESCRITIVO</th>
                                <th class="col-uni">UNID.</th>
                                <th class="col-qtd">QTD</th>
                                <th class="col-vunit">VL. UNIT</th>
                                <th class="col-total">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                            <tr style="background-color: #eee; font-weight: bold;">
                                <td colspan="8" class="text-right-p">TOTAL GERAL</td>
                                <td class="text-right-p">${formatCurrency(totalGeral)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('matriz-screen-content').innerHTML = html;
            document.getElementById('print-content').innerHTML = `<div class="print-area">${html}</div>`;
            openModal('modal-matriz');
        });

        function fetchData() {
            const opts = { download: true, header: true, skipEmptyLines: true, transformHeader: h => h.trim().toLowerCase() };
            Promise.all([
                new Promise(r => Papa.parse(SERVICES_CSV_URL, {...opts, complete: r})),
                new Promise(r => Papa.parse(PRICES_CSV_URL, {...opts, complete: r})),
                new Promise(r => Papa.parse(LOCATIONS_CSV_URL, {...opts, complete: r}))
            ]).then(([s, p, l]) => {
                // --- DEPURAÇÃO E DIAGNÓSTICO ---
                console.log("SERVICES Headers:", s.meta.fields);
                console.log("PRICES Headers:", p.meta.fields);
                console.log("LOCATIONS Headers:", l.meta.fields);
                // ---------------------------------------

                // Mapeamento de Preços (Robusto)
                const pMap = new Map(p.data.map(i => {
                    const key = i['código']?.trim() || i['cod']?.trim();
                    const valStr = i['valor'];
                    const val = valStr ? parseFloat(valStr.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                    return [key, val];
                }));

                const vcMap = new Map(l.data.map(i => [i['embarcação']?.trim(), i['cidade']?.trim()]));
                
                // Mapeamento de Dados (Robusto)
                allProcessedData = s.data.map(i => {
                    const v = i['embarcação']?.trim();
                    // Tenta múltiplas formas de chave para o preço
                    const codigo = i['código']?.trim() || i['item']?.trim() || i['cod']?.trim();
                    const price = pMap.get(codigo) || 0;
                    
                    // Tenta múltiplas formas de chave para a quantidade
                    const qtyStr = i['quantidade'] || i['qtd'] || i['quantidade numerica'];
                    const q = parseQuantity(qtyStr);
                    
                    const municipioName = VESSEL_MAPPING[v] || vcMap.get(v) || 'Não especificada';
                    
                    // Tenta múltiplas formas de chave para a data
                    const dateStr = i['referência'] || i['mês'] || i['data'];
                    const dataConclusao = parseDate(dateStr); 
                    
                    return { 
                        ...i, 
                        municipio: municipioName,
                        embarcação: v,
                        codigo: codigo,
                        descritivo: i['descritivo'] || i['descrição'] || i['descricao'] || i['descritivo'], 
                        referenciaStr: dateStr,
                        dataConclusao: dataConclusao, 
                        quantidadeNumerica: q, 
                        valorCalculado: price * q,
                        servico: i['serviço'] || i['serviço'] || '' 
                    };
                }).filter(i => i.dataConclusao && i.valorCalculado > 0); 

                console.log("Total processado:", allProcessedData.length);
                
                if (allProcessedData.length === 0) {
                    alert("AVISO CRÍTICO: Os dados foram carregados mas foram filtrados pois não há datas válidas ou preços > 0. Verifique o console (F12) para ver os nomes das colunas.");
                }

                populateReservatorioFilter();
                populateMonthFilter(allProcessedData);
                populateMunicipioFilter(allProcessedData);
                populateVesselFilter(allProcessedData);
                applyFilters();

            }).catch(err => {
                console.error("Erro detalhado:", err);
                document.getElementById('data-table-body').innerHTML = '<tr><td colspan="4" style="color:red; text-align:center;">[ FALHA AO CARREGAR DADOS - VERIFIQUE CONSOLE (F12) ]</td></tr>';
            });
        }

        // Event Listeners
        document.querySelectorAll('select').forEach(el => el.addEventListener('change', applyFilters));
        document.querySelectorAll('input[name="view-mode"]').forEach(el => el.addEventListener('change', applyFilters));
        
        // LISTENER DO BOLETIM MANTIDO
        document.getElementById('btn-generate-boletim').addEventListener('click', generateBoletim);
        
        document.getElementById('btn-download-xls').addEventListener('click', exportMatrixToXLS);

        document.getElementById('sort-qty').addEventListener('click', () => {
            currentSort.column = 'quantidadeNumerica';
            currentSort.direction = (currentSort.column === 'quantidadeNumerica' && currentSort.direction === 'desc') ? 'asc' : 'desc';
            applyFilters();
        });
        document.getElementById('sort-val').addEventListener('click', () => {
            currentSort.column = 'valorCalculado';
            currentSort.direction = (currentSort.column === 'valorCalculado' && currentSort.direction === 'desc') ? 'asc' : 'desc';
            applyFilters();
        });

        fetchData();
    });
    </script>
</body>
</html>
